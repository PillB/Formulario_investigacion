%% Diagramas de arquitectura y flujos de artefactos

erDiagram
  CASOS {
    string case_id PK "Identificador único del caso"
    string tipo_informe "Tipo de informe (Gerencia, Interno, Credicorp)"
    string categoria1 "Categoría de fraude – Nivel 1"
    string categoria2 "Categoría de fraude – Nivel 2"
    string modalidad "Modalidad de fraude"
    string canal "Canal de ocurrencia"
    string proceso "Proceso impactado"
  }

  CLIENTES {
    string id_cliente PK "Identificador del cliente"
    string case_id FK "Caso asociado"
    string tipo_id "Tipo de documento (DNI, RUC, Pasaporte, etc.)"
    string flag "Rol del cliente (Involucrado/Afectado/No aplica)"
  }

  CLIENT_PHONES {
    string id_cliente FK "Identificador del cliente"
    string telefono "Número de teléfono"
  }

  CLIENT_EMAILS {
    string id_cliente FK
    string correo "Dirección de correo electrónico"
  }

  CLIENT_ADDRESSES {
    string id_cliente FK
    string direccion "Dirección física"
  }

  TEAM_MEMBERS {
    string id_colaborador PK "ID del colaborador"
    string case_id FK "Caso asociado"
    string flag "Rol (Involucrado/Relacionado/No aplica)"
    string division "División"
    string area "Área"
    string servicio "Servicio"
    string puesto "Puesto"
    string nombre_agencia "Nombre de agencia (si aplica)"
    string codigo_agencia "Código de agencia (si aplica)"
    string tipo_falta "Tipo de falta"
    string tipo_sancion "Tipo de sanción"
  }

  PRODUCTS {
    string id_producto PK "Identificador del producto"
    string case_id FK "Caso asociado"
    string id_cliente FK "Cliente propietario"
    string categoria1 "Categoría Nivel 1 (override)"
    string categoria2 "Categoría Nivel 2 (override)"
    string modalidad "Modalidad (override)"
    string canal "Canal (override)"
    string proceso "Proceso impactado (override)"
    date fecha_ocurrencia "Fecha de ocurrencia"
    date fecha_descubrimiento "Fecha de descubrimiento"
    float monto_investigado "Monto investigado"
    string tipo_moneda "Tipo de moneda"
    float monto_perdida_fraude "Monto de pérdida de fraude"
    float monto_falla_procesos "Monto de falla en procesos"
    float monto_contingencia "Monto de contingencia"
    float monto_recuperado "Monto recuperado"
    float monto_pago_deuda "Monto de pago de deuda"
    string tipo_producto "Tipo de producto"
  }

  PRODUCT_CLAIMS {
    string id_reclamo PK "Identificador del reclamo"
    string case_id FK "Caso asociado"
    string id_producto FK "Producto asociado"
    string nombre_analitica "Nombre de analítica contable"
    string codigo_analitica "Código de analítica contable"
  }

  ACCIONADO {
    string id_producto FK
    string case_id FK
    string accionado "Tribu o entidad accionada"
  }

  INVOLVEMENT {
    string id_producto FK
    string case_id FK
    string id_colaborador FK
    float monto_asignado "Monto asignado al colaborador"
  }

  RISK_DETAILS {
    string risk_id PK "ID del riesgo (RSK-xxxxxx)"
    string case_id FK "Caso asociado"
    string lider "Líder del riesgo"
    string descripcion "Descripción del riesgo"
    string criticidad "Nivel de criticidad"
    float exposicion_residual "Exposición residual (US$)"
  }

  RISK_PLANS {
    string risk_id FK
    string case_id FK
    string plan_id "ID del plan de acción"
  }

  NORM_DETAILS {
    string norm_id PK "Número de norma (XXXX.XXX.XX.XX o generado)"
    string case_id FK
    string descripcion "Descripción de la norma"
    date fecha_vigencia "Fecha de vigencia"
  }

  ANALYSIS {
    string case_id FK
    string antecedentes
    string modus_operandi
    string hallazgos
    string descargos
    string conclusiones
    string recomendaciones
  }

  LLAVE_TECNICA {
    string case_id FK
    string id_producto FK
    string id_cliente FK
    string id_colaborador FK
    string id_reclamo FK
    date fecha_ocurrencia
  }

  CASOS ||--o{ CLIENTES : contiene
  CASOS ||--o{ TEAM_MEMBERS : tiene
  CASOS ||--o{ PRODUCTS : incluye
  CASOS ||--o{ RISK_DETAILS : identifica
  CASOS ||--o{ NORM_DETAILS : transgrede
  RISK_DETAILS ||--o{ RISK_PLANS : "tiene planes"
  CASOS ||--o{ ANALYSIS : documenta
  CLIENTES ||--o{ CLIENT_PHONES : "tiene teléfonos"
  CLIENTES ||--o{ CLIENT_EMAILS : "tiene correos"
  CLIENTES ||--o{ CLIENT_ADDRESSES : "tiene direcciones"
  CLIENTES ||--o{ PRODUCTS : posee
  TEAM_MEMBERS ||--o{ INVOLVEMENT : participa
  PRODUCTS ||--o{ INVOLVEMENT : "asigna colaboradores"
  PRODUCTS ||--o{ PRODUCT_CLAIMS : "origina reclamos"
  LLAVE_TECNICA ||--|| PRODUCTS : "usa"
  LLAVE_TECNICA ||--|| CLIENTES : "usa"
  LLAVE_TECNICA ||--|| TEAM_MEMBERS : "usa"
  LLAVE_TECNICA ||--|| PRODUCT_CLAIMS : "usa"
  PRODUCTS ||--o{ ACCIONADO : "accionado por"

%% Notas de almacenamiento de logs:
%% - Los eventos del formulario se escriben en `logs.csv` (carpeta local) y se espejan a `external drive/logs.csv`.
%% - Si `STORE_LOGS_LOCALLY` es `False`, la bitácora sólo se persistirá en la unidad externa y se reportarán advertencias si alguno de los destinos falla.

%% Diagrama de flujo del manejo de artefactos entre la app y los destinos locales/externos
flowchart LR
  subgraph UI[App Python Tkinter GUI]
    U1[Notebook<br/>(Caso/Clientes/Colaboradores/Productos)]
    U2[Riesgos y Normas]
    U3[Análisis]
    U4[Acciones & Resumen]
  end

  subgraph Validaciones
    V1[Validación por campo<br/>(fechas, montos, IDs, condicionales)]
    V2[Revisión de duplicados<br/>case+producto+cliente+team+fecha+reclamo]
  end

  subgraph Persistencia
    P1[autosave.json]
    P2[temp versions]
    P3[exports/ (CSV, JSON, MD, DOCX)]
    P4[external drive/<case>/]
    P5[logs.csv]
  end

  UI -->|Edición dispara| V1
  UI -->|Guardar y enviar| V2
  V1 -->|Errores a usuario| UI
  V2 -->|Bloquea duplicados| UI

  UI -->|Autosave| P1
  UI -->|Autosave incremental| P2
  UI -->|Exportadores| P3
  UI -->|Espejo| P4
  UI -->|Bitácora| P5

  P3 -->|Replica| P4
  P5 -->|Replica| P4
