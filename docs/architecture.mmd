%%{init: {'theme': 'default', 'fontFamily': 'Noto Sans, DejaVu Sans, Segoe UI, Arial, sans-serif', 'themeVariables': {'fontFamily': 'Noto Sans, DejaVu Sans, Segoe UI, Arial, sans-serif'}}}%%
flowchart TB
    subgraph Contexto
        gestion(["Gestión de Investigaciones"])
        analista([Investigador])
        tkapp[["Aplicación Python Tkinter GUI<br/>FormularioInvestigacionesFraude"]]
        databricks(["Catálogos empresariales futuro<br/>Databricks Parquet/CSV"])
        grc(["Registro de riesgos GRC"])
        normdb(["Índice maestro de normas"])
        gestion -- Asigna caso --> analista
        analista -- Llena formulario --> tkapp
        databricks -- Catálogos clientes/colaboradores --> tkapp
        grc -- Exportes de riesgos --> tkapp
        normdb -- Exportes de normas --> tkapp
    end

    subgraph Contenedores
        main[["main.py<br/>Arranque Tk/Ttk"]]
        appcore[["FormularioInvestigacionesFraude app.py<br/>Controlador"]]
        ui[["ui/frames/*<br/>Pestañas de Caso, Clientes, Team Members, Productos, Riesgos, Normas"]]
        services[["models/*<br/>Catálogos y autopoblado"]]
        validators[["validators.py<br/>Reglas + logs"]]
        reporting[["report_builder.py<br/>Generación JSON/CSV/MD/DOCX"]]
        files(("Sistema de archivos<br/>autosave.json, autosaves/<caso>/auto_N.json, exports/"))
        external(("Unidad externa<br/>backups y logs"))
    end

    subgraph Componentes_de_App
        caseTab[[Pestaña Caso]]
        clientTab[[Pestaña Clientes]]
        teamTab[[Pestaña Team Members]]
        productTab[[Pestaña Productos]]
        riskTab[[Pestaña Riesgos]]
        normTab[[Pestaña Normas]]
        actions[[Tab Acciones]]
        summary[[Tab Resumen]]
        autosave[[Auto guardado temporal]]
        logging[[Bitácora logs.csv]]
        importer[[Importadores CSV]]
        autofill[[Servicio de Catálogos<br/>Autopoblado]]
        reporter[[report_builder]]
    end

    analista --> main --> appcore
    appcore --> ui
    ui --> validators
    appcore --> services
    appcore --> reporting
    appcore --> files --> external

    appcore --> caseTab
    appcore --> clientTab
    appcore --> teamTab
    appcore --> productTab
    appcore --> riskTab
    appcore --> normTab
    appcore --> actions
    appcore --> summary

    importer --> caseTab
    importer --> clientTab
    importer --> teamTab
    importer --> productTab
    importer --> riskTab
    importer --> normTab
    importer --> summary

    caseTab --> autofill
    clientTab --> autofill
    teamTab --> autofill
    productTab --> autofill
    riskTab --> autofill
    normTab --> autofill
    actions --> autofill
    summary --> autofill

    appcore --> autosave
    appcore --> logging
    appcore --> reporter --> files
