%%{init: {'theme': 'default', 'fontFamily': 'Noto Sans, DejaVu Sans, Segoe UI, Arial, sans-serif', 'themeVariables': {'fontFamily': 'Noto Sans, DejaVu Sans, Segoe UI, Arial, sans-serif'}}}%%
flowchart TB
    subgraph Contexto
        gestion(["Gestión de Investigaciones"])
        analista([Investigador])
        tkapp[["Aplicación Python Tkinter GUI<br/>FormularioInvestigacionesFraude"]]
        databricks(["Catálogos empresariales futuro<br/>Databricks Parquet/CSV"])
        grc(["Registro de riesgos GRC"])
        normdb(["Índice maestro de normas"])
        gestion -- Asigna caso --> analista
        analista -- Llena formulario --> tkapp
        databricks -- Catálogos clientes/colaboradores --> tkapp
        grc -- Exportes de riesgos --> tkapp
        normdb -- Exportes de normas --> tkapp
    end

    subgraph Contenedores
        main[["main.py<br/>Arranque Tk/Ttk"]]
        appcore[["FormularioInvestigacionesFraude app.py<br/>Controlador"]]
        ui[["ui/frames/*<br/>Pestañas de Caso, Clientes, Team Members, Productos, Riesgos, Normas"]]
        services[["models/*<br/>Catálogos y autopoblado"]]
        validators[["validators.py<br/>Reglas + logs"]]
        reporting[["report_builder.py<br/>Generación CSV/JSON/MD/DOCX"]]
        alerta[["report/alerta_temprana.py<br/>Alerta temprana PPT"]]
        carta[["report/carta_inmediatez.py<br/>Cartas de inmediatez"]]
        files(("Sistema de archivos<br/>autosave.json, autosaves/<caso>/auto_N.json,<br/>exports/*.csv, version.json, md/docx/pptx"))
        historical(("exports/h_*.csv<br/>Consolidación histórica"))
        manifest(("pending_consolidation.txt<br/>Manifiesto de reaplicación"))
        external(("external drive/<id_caso>/</br>Backups, logs y consolidación"))
    end

    subgraph Componentes_de_App
        caseTab[[Pestaña Caso]]
        clientTab[[Pestaña Clientes]]
        teamTab[[Pestaña Team Members]]
        productTab[[Pestaña Productos]]
        riskTab[[Pestaña Riesgos]]
        normTab[[Pestaña Normas]]
        actions[[Tab Acciones (importar, exportar, recuperar)]]
        summary[[Tab Resumen]]
        autosave[[Auto guardado temporal]]
        logging[[Bitácora logs.csv]]
        importer[[Importadores CSV]]
        autofill[[Servicio de Catálogos<br/>Autopoblado]]
        reporter[[report_builder]]
    end

    analista --> main --> appcore
    appcore --> ui
    ui --> validators
    appcore --> services
    appcore --> reporting
    appcore --> files --> external

    appcore --> caseTab
    appcore --> clientTab
    appcore --> teamTab
    appcore --> productTab
    appcore --> riskTab
    appcore --> normTab
    appcore --> actions
    appcore --> summary

    importer --> caseTab
    importer --> clientTab
    importer --> teamTab
    importer --> productTab
    importer --> riskTab
    importer --> normTab
    importer --> summary

    caseTab --> autofill
    clientTab --> autofill
    teamTab --> autofill
    productTab --> autofill
    riskTab --> autofill
    normTab --> autofill
    actions --> autofill
    summary --> autofill

    actions -- "Guardar y enviar" --> reporting
    actions -- "Generar Word/Markdown" --> reporting
    actions -- "Generar PPT alerta temprana" --> alerta
    actions -- "Carta de inmediatez" --> carta

    appcore --> autosave
    appcore --> logging
    reporting --> files
    reporting --> historical
    alerta --> files
    carta --> files
    carta --> historical
    historical -- "Si la unidad externa existe" --> external
    files --> external
    historical -. "Si falta external drive se registra en manifiesto" .-> manifest
    manifest -- "Reaplica pendientes al detectar external drive" --> external
