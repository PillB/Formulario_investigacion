%% Diagrama de flujo circular: formulario -> eventos.csv -> formulario
flowchart LR
    form["Formulario de investigación<br/>(Tabs y campos)"]
    eventos[(eventos.csv)]
    analisis_csv[(analisis.csv)]
    note_eventos["Cada fila de `eventos.csv` representa la combinación Producto × Reclamo × Involucramiento del caso"]
    note_mapeo_eventos["Columnas canónicas/legacy salen de report_builder.build_event_rows<br/>(settings.EVENTOS_HEADER_CANONICO/LEGACY)."]
    note_fechas_producto["Si un producto no tiene fechas, puede heredar las del caso<br/>(fecha_de_ocurrencia / fecha_de_descubrimiento)."]
    combinacion_eventos["Combinación Producto×Reclamo×Involucramiento (report_builder.build_event_rows)"]

    %% Impacto en número de filas
    subgraph impacto_filas[Multiplicación de filas en eventos.csv]
        producto_uno["Producto (1)"]
        reclamos_n["Reclamos (N)"]
        involucramientos_n["Involucramientos (N)"]
        filas_eventos["Filas en eventos.csv (N)"]
        producto_uno --> reclamos_n --> involucramientos_n --> filas_eventos
    end

    %% Caso
    subgraph caso[Tab Caso]
        caso_id["Número de caso → case_id / id_caso"]
        caso_tipo["Tipo de informe → tipo_informe"]
        caso_cat1["Categoría 1 → categoria_1 / categoria1"]
        caso_cat2["Categoría 2 → categoria_2 / categoria2"]
        caso_modalidad["Modalidad → modalidad"]
        caso_canal["Canal → canal"]
        caso_proceso["Proceso impactado → proceso_impactado / proceso"]
        caso_costos["Centro de costos → centro_costos"]
        caso_fecha_oc["Fecha de ocurrencia (caso) → fecha_de_ocurrencia"]
        caso_fecha_desc["Fecha de descubrimiento (caso) → fecha_de_descubrimiento"]
        caso_invest_id["Matrícula investigador → matricula_investigador"]
        caso_invest_nombre["Investigador: nombre → investigador_nombre"]
        caso_invest_puesto["Investigador: puesto → investigador_cargo"]
    end

    %% Clientes
    subgraph clientes[Tab Clientes]
        cliente_tipo_id["Tipo de ID → cliente_tipo_id / tipo_id_cliente_involucrado"]
        cliente_id["ID del cliente → id_cliente"]
        cliente_nombres["Nombres → cliente_nombres / nombres_cliente_involucrado"]
        cliente_apellidos["Apellidos → cliente_apellidos / apellidos_cliente_involucrado"]
        cliente_flag["Flag → cliente_flag / flag_cliente_involucrado"]
        cliente_accionado["Accionado (listbox múltiple) → cliente_accionado / accionado_cliente_relacionado"]
        cliente_tel["Teléfonos → cliente_telefonos / telefonos_cliente_relacionado"]
        cliente_correo["Correos → cliente_correos / correos_cliente_relacionado"]
        cliente_direccion["Direcciones → cliente_direcciones / direcciones_cliente_relacionado"]
    end

    %% Colaboradores
    subgraph colaboradores[Tab Colaboradores]
        colab_id["ID colaborador → id_colaborador / matricula_colaborador_involucrado"]
        colab_nombres["Nombres → colaborador_nombres / nombres_involucrado"]
        colab_apellidos["Apellidos → colaborador_apellidos / apellido_paterno_involucrado"]
        colab_flag["Flag → colaborador_flag"]
        colab_division["División → colaborador_division / division"]
        colab_area["Área → colaborador_area / area"]
        colab_servicio["Servicio → colaborador_servicio / servicio"]
        colab_puesto["Puesto → colaborador_puesto / puesto"]
        colab_fecha_inm["Fecha carta inmediatez → colaborador_fecha_carta_inmediatez"]
        colab_fecha_ren["Fecha carta renuncia → colaborador_fecha_carta_renuncia / fecha_cese"]
        colab_agencia_nombre["Nombre agencia → colaborador_nombre_agencia / nombre_agencia"]
        colab_agencia_codigo["Código agencia → colaborador_codigo_agencia / codigo_agencia"]
        colab_tipo_falta["Tipo de falta → colaborador_tipo_falta / tipo_de_falta"]
        colab_tipo_sancion["Tipo de sanción → colaborador_tipo_sancion / tipo_sancion"]
    end

    %% Productos
    subgraph productos[Tab Productos]
        prod_id["ID del producto → product_id / id_producto"]
        prod_cliente["Cliente (selector) → id_cliente"]
        prod_cat1["Categoría 1 → categoria_1 / categoria1"]
        prod_cat2["Categoría 2 → categoria_2 / categoria2"]
        prod_modalidad["Modalidad → modalidad"]
        prod_canal["Canal → canal"]
        prod_proceso["Proceso → proceso_impactado / proceso"]
        prod_tipo["Tipo de producto → tipo_de_producto / tipo_producto"]
        prod_fecha_oc["Fecha de ocurrencia (producto) → fecha_ocurrencia"]
        prod_fecha_desc["Fecha de descubrimiento (producto) → fecha_descubrimiento"]
        prod_monto_inv["Monto investigado → monto_investigado"]
        prod_moneda["Moneda → tipo_moneda"]
        prod_monto_perdida["Monto pérdida fraude → monto_fraude_interno_soles / monto_perdida_fraude"]
        prod_monto_falla["Monto falla procesos → monto_falla_en_proceso_soles / monto_falla_procesos"]
        prod_monto_cont["Monto contingencia → monto_contingencia_soles / monto_contingencia"]
        prod_monto_rec["Monto recuperado → monto_recuperado_soles / monto_recuperado"]
        prod_monto_pago["Monto pago deuda → monto_pagado_soles / monto_pago_deuda"]
    end

    %% Reclamos
    subgraph reclamos[Sección Reclamos]
        reclamo_id["ID reclamo → id_reclamo"]
        reclamo_codigo["Código analítica → codigo_analitica"]
        reclamo_nombre["Nombre analítica → nombre_analitica"]
    end

    %% Involucramientos
    subgraph involucramientos[Sección Involucramientos]
        invol_colab["Colaborador involucrado → matricula_colaborador_involucrado / id_colaborador"]
        invol_cliente["Cliente involucrado → client_id_involucrado / id_cliente_involucrado"]
        invol_monto["Monto asignado → monto_asignado"]
    end

    %% Análisis
    subgraph analisis[Tab Análisis]
        anal_antecedentes["Antecedentes → antecedentes<br/>(solo analisis.csv)"]
        anal_modus_operandi["Modus operandi → modus_operandi<br/>(solo analisis.csv)"]
        anal_hallazgos["Hallazgos → hallazgos<br/>(solo analisis.csv)"]
        anal_descargos["Descargos → descargos<br/>(solo analisis.csv)"]
        anal_conclusiones["Conclusiones → conclusiones<br/>(solo analisis.csv)"]
        anal_recomendaciones["Recomendaciones → recomendaciones<br/>(solo analisis.csv)"]
        anal_comentario_breve["Comentario breve → comentario_breve"]
        anal_comentario_amplio["Comentario amplio → comentario_amplio"]
    end

    %% Leyenda
    subgraph leyenda[Leyenda]
        leyenda_eventos["Solo comentarios breve/amplio se exportan en eventos.csv"]
    end

    %% Formulario agrupado
    form --> caso
    form --> clientes
    form --> colaboradores
    form --> productos
    form --> reclamos
    form --> involucramientos
    form --> analisis

    %% Relaciones con el subgrafo de multiplicación de filas
    productos -.-> producto_uno
    reclamos -.-> reclamos_n
    involucramientos -.-> involucramientos_n

    %% Exportación circular hacia eventos.csv
    note_eventos -.-> eventos
    combinacion_eventos -.-> eventos
    note_mapeo_eventos -.-> combinacion_eventos
    note_fechas_producto -.-> prod_fecha_oc
    note_fechas_producto -.-> prod_fecha_desc
    combinacion_eventos -.-> filas_eventos
    filas_eventos --> eventos
    caso_id --> eventos
    caso_tipo --> eventos
    caso_cat1 --> eventos
    caso_cat2 --> eventos
    caso_modalidad --> eventos
    caso_canal --> eventos
    caso_proceso --> eventos
    caso_costos --> eventos
    caso_fecha_oc --> eventos
    caso_fecha_desc --> eventos
    caso_invest_id --> eventos
    caso_invest_nombre --> eventos
    caso_invest_puesto --> eventos

    cliente_tipo_id --> eventos
    cliente_id --> eventos
    cliente_nombres --> eventos
    cliente_apellidos --> eventos
    cliente_flag --> eventos
    cliente_accionado --> eventos
    cliente_tel --> eventos
    cliente_correo --> eventos
    cliente_direccion --> eventos

    colab_id --> eventos
    colab_nombres --> eventos
    colab_apellidos --> eventos
    colab_flag --> eventos
    colab_division --> eventos
    colab_area --> eventos
    colab_servicio --> eventos
    colab_puesto --> eventos
    colab_fecha_inm --> eventos
    colab_fecha_ren --> eventos
    colab_agencia_nombre --> eventos
    colab_agencia_codigo --> eventos
    colab_tipo_falta --> eventos
    colab_tipo_sancion --> eventos

    prod_id --> eventos
    prod_cliente --> eventos
    prod_cat1 --> eventos
    prod_cat2 --> eventos
    prod_modalidad --> eventos
    prod_canal --> eventos
    prod_proceso --> eventos
    prod_tipo --> eventos
    prod_fecha_oc --> eventos
    prod_fecha_desc --> eventos
    prod_monto_inv --> eventos
    prod_moneda --> eventos
    prod_monto_perdida --> eventos
    prod_monto_falla --> eventos
    prod_monto_cont --> eventos
    prod_monto_rec --> eventos
    prod_monto_pago --> eventos

    reclamo_id --> eventos
    reclamo_codigo --> eventos
    reclamo_nombre --> eventos

    invol_colab --> eventos
    invol_cliente --> eventos
    invol_monto --> eventos

    anal_comentario_breve --> eventos
    anal_comentario_amplio --> eventos
    anal_antecedentes --> analisis_csv
    anal_modus_operandi --> analisis_csv
    anal_hallazgos --> analisis_csv
    anal_descargos --> analisis_csv
    anal_conclusiones --> analisis_csv
    anal_recomendaciones --> analisis_csv

    %% Importación circular desde eventos.csv
    eventos --> caso_id
    eventos --> caso_tipo
    eventos --> caso_cat1
    eventos --> caso_cat2
    eventos --> caso_modalidad
    eventos --> caso_canal
    eventos --> caso_proceso
    eventos --> caso_costos
    eventos --> caso_fecha_oc
    eventos --> caso_fecha_desc
    eventos --> caso_invest_id
    eventos --> caso_invest_nombre
    eventos --> caso_invest_puesto

    eventos --> cliente_tipo_id
    eventos --> cliente_id
    eventos --> cliente_nombres
    eventos --> cliente_apellidos
    eventos --> cliente_flag
    eventos --> cliente_accionado
    eventos --> cliente_tel
    eventos --> cliente_correo
    eventos --> cliente_direccion

    eventos --> colab_id
    eventos --> colab_nombres
    eventos --> colab_apellidos
    eventos --> colab_flag
    eventos --> colab_division
    eventos --> colab_area
    eventos --> colab_servicio
    eventos --> colab_puesto
    eventos --> colab_fecha_inm
    eventos --> colab_fecha_ren
    eventos --> colab_agencia_nombre
    eventos --> colab_agencia_codigo
    eventos --> colab_tipo_falta
    eventos --> colab_tipo_sancion

    eventos --> prod_id
    eventos --> prod_cliente
    eventos --> prod_cat1
    eventos --> prod_cat2
    eventos --> prod_modalidad
    eventos --> prod_canal
    eventos --> prod_proceso
    eventos --> prod_tipo
    eventos --> prod_fecha_oc
    eventos --> prod_fecha_desc
    eventos --> prod_monto_inv
    eventos --> prod_moneda
    eventos --> prod_monto_perdida
    eventos --> prod_monto_falla
    eventos --> prod_monto_cont
    eventos --> prod_monto_rec
    eventos --> prod_monto_pago

    eventos --> reclamo_id
    eventos --> reclamo_codigo
    eventos --> reclamo_nombre

    eventos --> invol_colab
    eventos --> invol_cliente
    eventos --> invol_monto

    eventos --> anal_comentario_breve
    eventos --> anal_comentario_amplio
    analisis_csv --> anal_antecedentes
    analisis_csv --> anal_modus_operandi
    analisis_csv --> anal_hallazgos
    analisis_csv --> anal_descargos
    analisis_csv --> anal_conclusiones
    analisis_csv --> anal_recomendaciones
