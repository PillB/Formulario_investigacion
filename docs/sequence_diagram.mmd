%%{init: {'theme': 'default'}}%%
sequenceDiagram
    autonumber
    participant Gestion as Gestión
    participant Investigador as Investigador
    participant UI as UI Python Tkinter GUI (FormularioInvestigacionesFraude)
    participant Valid as Validaciones (validators.py)
    participant Catalogos as Servicio de Catálogos/Autopoblado
    participant Import as Importador CSV (iter_massive_csv_rows)
    participant Autosave as Autoguardado
    participant Logs as logger/logs.csv
    participant Reporte as Reportes base (report_builder)
    participant Alertas as Alerta temprana (report/alerta_temprana.py)
    participant Cartas as Cartas (report/carta_inmediatez.py)
    participant Resumen as Resumen Ejecutivo (pendiente)
    participant Historico as Históricos h_*.csv
    participant External as external drive/<id_caso>/

    Gestion->>Investigador: Asigna caso y solicita informe
    Investigador->>UI: Abre aplicación y selecciona pestañas
    Note over UI: Entrada manual de datos
    Investigador->>UI: Escribe campos (Entry/Combobox/Text)
    UI->>Valid: FieldValidator valida formato/montos/fechas
    Valid-->>UI: Errores inline o messagebox
    UI->>Logs: log_event(tipo="validacion/navegacion")
    UI->>Autosave: request_autosave() (debounce 4s)
    Autosave-->>UI: save_auto() + temp_version

    Note over UI,Import: Carga masiva
    Investigador->>UI: Acciones > Importar CSV
    UI->>Import: _start_background_import(worker)
    Import-->>UI: payload de filas normalizadas
    UI->>UI: _apply_*_import_payload pobla pestañas (Caso/Cliente/Equipo/Producto/Riesgo/Norma/Resumen)
    UI->>Valid: Validación por fila y duplicados (cliente/colaborador/riesgo/producto/norma)
    UI->>Logs: log_event(subtipo="import")
    UI->>Autosave: _notify_dataset_changed()

    Note over UI,Catalogos: Autocompletado/Autopoblado
    Investigador->>UI: Ingresa IDs (cliente/colaborador/producto/caso)
    UI->>Catalogos: lookup en catálogos locales y snapshots
    Catalogos-->>UI: Datos encontrados + metadatos
    UI->>Valid: should_autofill_field respeta campos editados
    UI->>UI: Actualiza combobox/entries/tablas
    Valid->>Catalogos: Validación de integridad referencial (IDs existen en catálogos/snapshots)
    UI->>Logs: log_event(subtipo="autofill")

    Note over Autosave: Autosave y logging continuos
    loop Cada 5 min
        UI->>Autosave: autosave_cycle() -> autosaves/<caso>/auto_N.json
    end
    loop Cada interacción
        UI->>Logs: Encola evento
        Logs-->>Logs: flush a logs.csv y external drive
    end

    Note over Reporte: Guardado y exportes extendidos
    Investigador->>UI: Acciones > Guardar y enviar / exportar
    UI->>Valid: Validación global de todas las pestañas
    UI->>Reporte: build_report + build_docx + save_md
    Reporte-->>Investigador: CSV/JSON/Markdown/DOCX en exports/ (incluye eventos.csv y eventos_lhcl.csv)
    UI->>Alertas: build_alerta_temprana_ppt()
    Alertas-->>Investigador: PPTX de alerta temprana
    UI->>Cartas: Abrir diálogo y generar cartas de inmediatez
    Cartas-->>Investigador: DOCX + CSV de cartas y fechas en pestaña colaboradores
    UI->>Resumen: build_resumen_ejecutivo() (pendiente)
    Resumen-->>Investigador: Resumen Ejecutivo (N/A en código)
    UI->>Historico: append_historical_records -> h_*.csv (incluye h_eventos.csv y h_eventos_lhcl.csv)
    Historico-->>External: Espejo automático al detectar external drive
    Historico-->>UI: pending_consolidation.txt cuando falta la unidad externa
    UI->>Autosave: save_temp_version() + backup en external drive
    UI->>Logs: log_event("export", widget_id=btn_docx/md/alerta_temprana/carta_inmediatez)
